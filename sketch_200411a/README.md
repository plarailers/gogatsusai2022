# 自動運転プログラム
## 使い方
- ESP32に列車IDを割り当てるのは、Communication.pdeのvoid setup()内で行う。
- サーボやCdSにIDを割り当てるのは、State.pdeの冒頭付近でまとめて行う。
## 中身
- com_to_arduino.ino (谷口)
  - Arduinoによるサーボとセンサの制御プログラム
  - junctionId を受け取り、ポイントを切り替える。
  - CdSが車両の通過を検知したとき、通過したCdSの sensorId を送る。
- Communication.pde (三浦)
  - ESP32およびArduinoとの通信プログラム。
  - ESP32へinputを送り、ESP32からホールセンサの信号を受け取る。
  - Arduinoとの通信。切り替えるポイントの junctionId を送り、検知された sensorId を受け取る。
  - simulationMode = true にすると、実機が無くてもシミュレーションできる。
- sketch_200411a.pde (松田)
  - 自動運転における最上位のプログラム。
  - Communication から受け取ったホールセンサ信号とセンサ信号(sensorId)を基にシミュレーションを更新。
  - 各車両の targetSpeed と、切り替えるポイントの junctionId を生成し、Communication に渡す。
- その他自動運転用のソース (松田)
  - Display.pde
    - 表示部。*路線の形が変わると書き換え必要*
  - Operation.pde
    - 運行制御部。ぐちゃぐちゃなコードになってしまった、申し訳ない。*先頭の定数は適宜書き換える*
    - 大きく、・時刻表更新　・列車制御(停止点生成+目標速度生成)　・ポイント制御　・CdSによる位置補正 からなる。
    - [ポイント切り替えフロー](https://docs.google.com/presentation/d/1FLRcOdt9yPmmUvgX4QQlcK1Wu0_f3pIRu_IYb0js2sA/edit)
    - [列車制御フロー](https://docs.google.com/presentation/d/1mzPHkNDHomJLEz3IfEigwqfWPheJ2oUQnqut5B9ZuXk/edit?usp=sharing)
  - State.pde
    - 線路の形状をはじめとするオブジェクトの定義。*路線の形が変わると書き換え必要*
    - Junctionをノード、Sectionをエッジとする有向グラフ。
  - Timetable.pde
    - 時刻表の処理。
  - Table.csv
    - 時刻表データ。